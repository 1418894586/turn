package main

import "gitlab.com/pions/pion/turn/stun"
import (
	"fmt"
	"net"
	"time"

	"gitlab.com/pions/pion/turn/server"
)

func main() {
	msg1 := []byte("\x00\x01\x00\x58\x21\x12\xa4\x42\x48\x75\x38\x77\x4e\x4f\x49\x53\x62\x54\x65\x4a\x00\x06\x00\x1b\x35\x50\x4e\x32\x71\x6d\x57\x71\x42\x6c\x3a\x34\x68\x52\x42\x6d\x66\x4b\x48\x75\x58\x6a\x4f\x67\x6b\x56\x4a\x00\x80\x2a\x00\x08\xd2\xdb\x70\x25\x70\x6b\xcd\x98\x00\x25\x00\x00\x00\x24\x00\x04\x6e\x7f\x1e\xff\x00\x08\x00\x14\x5a\xca\x22\xd7\xf4\x39\xfa\xde\xaf\xd3\x9b\xd6\xec\x00\xd4\x96\xe2\x17\x09\x32\x80\x28\x00\x04\x78\x5d\x2e\xeb")
	msg := []byte("\x00\x01\x00\x58" +
		"\x21\x12\xa4\x42" +
		"\xb7\xe7\xa7\x01\xbc\x34\xd6\x86\xfa\x87\xdf\xae" +
		"\x80\x22\x00\x10" +
		"STUN test client" +
		"\x00\x24\x00\x04" +
		"\x6e\x00\x01\xff" +
		"\x80\x29\x00\x08" +
		"\x93\x2f\xf9\xb1\x51\x26\x3b\x36" +
		"\x00\x06\x00\x09" +
		"\x65\x76\x74\x6a\x3a\x68\x36\x76\x59\x20\x20\x20" +
		"\x00\x08\x00\x14" +
		"\x9a\xea\xa7\x0c\xbf\xd8\xcb\x56\x78\x1e\xf2\xb5" +
		"\xb2\xd3\xf2\x49\xc1\xb5\x71\xa2" +
		"\x80\x28\x00\x04" +
		"\xe5\x7a\x3b\xcf",
	)
	msg2 := []byte("\x01\x01\x00\x48" +
		"\x21\x12\xa4\x42" +
		"\xb7\xe7\xa7\x01\xbc\x34\xd6\x86\xfa\x87\xdf\xae" +
		"\x80\x22\x00\x0b" +
		"\x74\x65\x73\x74\x20\x76\x65\x63\x74\x6f\x72\x20" +
		"\x00\x20\x00\x14" +
		"\x00\x02\xa1\x47" +
		"\x01\x13\xa9\xfa\xa5\xd3\xf1\x79" +
		"\xbc\x25\xf4\xb5\xbe\xd2\xb9\xd9" +
		"\x00\x08\x00\x14" +
		"\xa3\x82\x95\x4e\x4b\xe6\x7b\xf1\x17\x84\xc9\x7c" +
		"\x82\x92\xc2\x75\xbf\xe3\xed\x41" +
		"\x80\x28\x00\x04" +
		"\xc8\xfb\x0b\x4c",
	)

	s := server.NewStunServer()
	errors := make(chan error)

	go func() {
		err := s.Listen("", stun.DefaultPort)
		errors <- err
	}()

	time.Sleep(10 * time.Millisecond)
	c, err := net.Dial("udp", fmt.Sprintf(":%d", stun.DefaultPort))
	if err != nil {
		panic(err)
	}

	c.Write(msg)
	c.Write(msg1)
	c.Write(msg2)

	select {
	case e := <-errors:
		panic(e)
	}

}
